<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NOTE TRIASE IGD RSUD KL</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.13.1/datatables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.1/css/fixedHeader.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.0/css/responsive.bootstrap5.min.css">
  
</head>
  
<body>
  <div class="container">
    <div class="row">
      <div class="col-12">
        <br>
        <h3 class="text-center my-4">Note Triase IGD RSKL</h3>
        <p class="text-center my-4" id="waktuSekarang"> </p>
        
        <!-- Button trigger modal -->
        <div class="text-center">
        <button type="button" class="btn btn-primary mb-3" id="tambahPasien">
          + Tambah Pasien
        </button>
        </div>

        <table id="data-IGD" class="table table-striped table-bordered nowrap" style="width: 100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nama Pasien</th>
              <th>Catatan</th>
              <th>Rencana / Plan</th>
              <th>Timestamp</th>
              <th>Aksi</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <h4 class="modal-title">Tambah Pasien</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="formPasien">
            <div class="mb-3">
              <input type="text" class="form-control" id="waktuForm" readonly>
            </div>

            <input type="hidden" class="form-control" id="idPasien">
            <div class="mb-3">
              <label class="col-form-label">Nama Pasien <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="namaPasien" required>
            </div>

            <div class="mb-3">
              <label class="col-form-label">Catatan (Keluhan, RPD, RPO, TTV pasien) <span class="text-danger">*</span></label>
              <textarea class="form-control" id="catatan" rows="6" required></textarea>
            </div>

            <div class="mb-3">
              <label class="col-form-label">Rencana / Plan</label>
              <textarea class="form-control" id="rencana" rows="2"></textarea>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-warning" id="simpanPasien">Simpan Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/v/bs5/dt-1.13.1/datatables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.1/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.0/js/dataTables.responsive.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

  <script>
    $(document).ready(function () {
      const BASE_URL = "https://script.google.com/macros/s/AKfycbwrtBHwjpS9Ise8WIyZthtneG7Px_4YQCLTt-7Hb4mJtYILCJ6GKIZ29DhIlGhsoIYNVg/exec";
      
      const table = $("#data-IGD").DataTable({
      ajax: BASE_URL + "?action=get-product",
      columns: [
        { data: "id" },
        { data: "nama" },
        { data: "catatan" },
        { data: "rencana" },
        { data: "timestamp",
          render: function (data) {
            return formatTimestampSingkat(data);
          }
        },
        {
          data: null,
          orderable: false,
          render: function () {
            return `
              <div class="btn-group">
                <button class="btn btn-warning btn-sm edit">Edit</button>
                <button class="btn btn-danger btn-sm hapus">Hapus</button>
              </div>
            `;
          }
        },
      ],
      rowId: "id",
      rowCallback: function(row, data) {
        if (data.rencana && data.rencana.trim() !== "") {
          $(row).addClass("row-rencana-isi");   // kasih class khusus
        } else {
          $(row).removeClass("row-rencana-isi"); // kalau kosong hapus class
        }
      },
      responsive: {
        breakpoints: [
          { name: 'desktop', width: Infinity },
          { name: 'tablet',  width: 1024 },
          { name: 'mobile',  width: 768 }
        ]
      },
      columnDefs: [
        { targets: 0, className: "desktop" },   // ID hanya tampil di desktop
        { responsivePriority: 1, targets: 1 },  // Nama wajib tampil
        { responsivePriority: 2, targets: 2 },  // Catatan wajib tampil
        { targets: 3, className: "desktop" },  // Rencana bisa disembunyikan
        { targets: 4, className: "desktop" },  // Timestamp bisa disembunyikan
        { targets: 5, className: "desktop" }   // Aksi bisa disembunyikan
      ],
    });

      // Edit Pasien
      $('#data-IGD tbody').on('click', 'button.edit', function () {
        const tr = $(this).closest('tr');
        const row = table.row(tr.hasClass('child') ? tr.prev() : tr);
        const data = row.data();

        $('#idPasien').val(data.id);
        $('#namaPasien').val(data.nama);
        $('#catatan').val(data.catatan);
        $('#rencana').val(data.rencana);
        $('#myModal .modal-title').text('Edit Pasien');
        $('#myModal').modal('show');
      });

      // Reset modal title saat ditutup
      $('#myModal').on('hidden.bs.modal', () => {
        $('#formPasien')[0].reset();
        $('#idPasien').val('');
        $('#myModal .modal-title').text('Tambah Pasien');
      });

      // Tambah Pasien
      $('#tambahPasien').on('click', () => {
        $('#formPasien')[0].reset();
        $('#idPasien').val('');
        $('#myModal').modal('show');
      });

      // Simpan Pasien
      $('#simpanPasien').on('click', function () {
        const $btn = $(this); // simpan referensi tombol
        const idPasien = $('#idPasien').val();
        const namaPasien = $('#namaPasien').val().trim();
        const catatan = $('#catatan').val().trim();
        const rencana = $('#rencana').val().trim();
      
        if (!namaPasien || !catatan) {
          swal({
            title: "Gagal!",
            text: "Mohon lengkapi kolom yang dibintangi ya!",
            icon: "error",
            buttons: false,   // ðŸ”¹ Hilangkan tombol OK
            timer: 2000       // ðŸ”¹ Auto close dalam 2 detik
          });
          return;
        }

        // ðŸ”¹ Ubah tombol jadi loading
        $btn.prop("disabled", true).html(
          `<span class="spinner-border spinner-border-sm me-2"></span> Menyimpan...`
        );
      
        // ðŸ”¹ Tampilkan pesan loading swal
        swal({
          title: "Menyimpan...",
          text: "Mohon tunggu sebentar",
          buttons: false,
          closeOnClickOutside: false,
          closeOnEsc: false,
          icon: "info"
        });
      
        let apiURL = "";
        if (idPasien) {
          apiURL = `${BASE_URL}?action=update&id=${idPasien}&nama=${encodeURIComponent(namaPasien)}&catatan=${encodeURIComponent(catatan)}&rencana=${encodeURIComponent(rencana)}`;
        } else {
          apiURL = `${BASE_URL}?action=insert&nama=${encodeURIComponent(namaPasien)}&catatan=${encodeURIComponent(catatan)}&rencana=${encodeURIComponent(rencana)}`;
        }
      
        $.getJSON(apiURL, function (result) {
          if (result.success) {
            swal({
              title: "Sukses!",
              text: result.message,
              icon: "success",
              buttons: false,
              timer: 1500
            });
            $('#myModal').modal('hide');
            table.ajax.reload();
          } else {
            swal({
              title: "Gagal!",
              text: result.message,
              icon: "error",
              buttons: false,
              timer: 2000
            });
          }
        }).fail(() => {
          swal({
            title: "Error!",
            text: "Gagal menghubungi server.",
            icon: "error",
            buttons: false,
            timer: 2000
          });
        }).always(() => {
          // ðŸ”¹ Reset tombol kembali normal
          $btn.prop("disabled", false).text("Simpan Data");
        });
      });

      // Hapus Pasien
      $('#data-IGD tbody').on('click', 'button.hapus', function () {
      const tr = $(this).closest('tr');
      const row = table.row(tr.hasClass('child') ? tr.prev() : tr);
      const data = row.data();

      swal({
        title: `Hapus pasien ${data.nama}?`,
        text: "Data yang sudah dihapus tidak bisa dikembalikan!",
        icon: "warning",
        buttons: ["Batal", "Ya, Hapus"],
        dangerMode: true
      }).then((willDelete) => {
        if (willDelete) {
          const apiURL = `${BASE_URL}?action=delete&id=${data.id}`;
          $.getJSON(apiURL, function (result) {
            if (result.success) {
              swal({
                title: "Sukses!",
                text: result.message,
                icon: "success",
                buttons: false,
                timer: 1500
              });
              table.ajax.reload();
            } else {
              swal({
                title: "Gagal!",
                text: result.message,
                icon: "error",
                buttons: false,
                timer: 2000
              });
            }
          }).fail(() => {
            swal({
              title: "Error!",
              text: "Gagal menghubungi server.",
              icon: "error",
              buttons: false,
              timer: 2000
            });
          });
        }
      });
    });
    });

    // âœ… Set default global DataTables
      $.extend(true, $.fn.dataTable.defaults, {
        order: [[4, "desc"]] // urutkan kolom ke-5 (Timestamp) DESC
      });

    // === Time Update ===
    function updateWaktu() {
      const now = new Date();
      const tanggal = now.toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    
      const pad = (n) => String(n).padStart(2, '0');
      const jam = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      const fullText = `${tanggal} , ${jam} WIB`;
    
      // Update teks header
      document.getElementById("waktuSekarang").innerHTML = fullText;
    
      // Kalau modal sedang terbuka, update juga ke form
      if ($('#myModal').hasClass('show')) {
        $('#waktuForm').val(fullText);
      }
    }
    
    updateWaktu();
    setInterval(updateWaktu, 1000);

    // === Formatter Timestamp Singkat ===
    function formatTimestampSingkat(data) {
      if (!data) return "-";
      const date = new Date(data);

      const pad = (n) => String(n).padStart(2, "0");
      const tgl = pad(date.getDate());
      const bulan = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun",
                 "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
      const bln = bulan[date.getMonth()];
      const thn = date.getFullYear();

      const jam = pad(date.getHours());
      const menit = pad(date.getMinutes());
      const detik = pad(date.getSeconds());

      return `${tgl} ${bln} ${thn} , ${jam}:${menit}:${detik} WIB`;
    }
  </script>

<footer class="text-center my-4">
  <p>&copy; <script>document.write(new Date().getFullYear());</script><br>Created by M Yudhi Akbar</p>
</footer>
</body>
</html>
